{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="flex-1 flex flex-col p-2 lg:p-4 rounded-r-lg">
  <!-- Cabeçalho e mensagens igual ao template que você já tinha -->

  <div class="flex-1 p-2 lg:p-4 shadow-sm bg-[#efeae2] dark:bg-[#0b141a] overflow-y-auto">
    <div class="flex flex-col gap-2" id="message-container">
      {% for message in messages %}
        <div class="flex w-full gap-4">
          <div class="bg-green-200 dark:bg-green-500 p-2 rounded-lg ml-auto max-w-[70%] text-right">
            {{ message.question }}
          </div>
        </div>
        <div class="flex w-full gap-4">
          <div class="bg-gray-200 dark:bg-gray-500 p-2 rounded-lg mr-auto max-w-[70%] text-left">
            {{ message.response|safe }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <form method="POST" id="chat-form" class="h-16 rounded-b-lg shadow-lg flex items-center gap-2">
    {% csrf_token %}
    <input type="hidden" name="session_id" value="{{ session_id }}">
    <input type="text" name="message" required placeholder="Digite uma mensagem">
    <button type="submit">Enviar</button>
  </form>
</div>

<script>
document.getElementById("chat-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const input = e.target.querySelector("input[name='message']");
    const session_id = e.target.querySelector("input[name='session_id']").value;
    const message = input.value;
    input.value = "";

    await fetch("{% url 'chat' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ message, session_id })
    });

    updateMessages(session_id);
});

async function updateMessages(session_id) {
    const res = await fetch(`/chat/json/${session_id}/`);
    const data = await res.json();
    const container = document.getElementById("message-container");
    container.innerHTML = "";
    data.messages.forEach(msg => {
        container.innerHTML += `
        <div class="flex w-full gap-4">
            <div class="bg-green-200 dark:bg-green-500 p-2 rounded-lg ml-auto max-w-[70%] text-right">
                ${msg.question}
            </div>
        </div>
        <div class="flex w-full gap-4">
            <div class="bg-gray-200 dark:bg-gray-500 p-2 rounded-lg mr-auto max-w-[70%] text-left">
                ${msg.response}
            </div>
        </div>
        `;
    });
    container.scrollTop = container.scrollHeight;
}
</script>
{% endblock %}
